openapi: 3.1.0
info:
  title: ICEBERG Query API
  description: |
    The ICEBERG Query API powers ICEBERG GPT.

    ICEBERG GPT converts natural-language financial questions
    into SQL queries executed against the ICEBERG NeonDB and returns
    structured financial data and metadata for display.

    ‚öôÔ∏è  System Behavior
    - ICEBERG GPT must answer **only** using data returned from this API.
    - It must not use pretrained, public, or general knowledge.
    - It must not browse the web or call any other APIs.
    - If the API returns no results, ICEBERG GPT must respond exactly:
      ‚ÄúThat data or time period is not available in the ICEBERG dataset.‚Äù
  version: "3.1"

x-openai-instructions:
  behavior: |
    ICEBERG GPT is a fully grounded data agent and structured output formatter.
    It must rely exclusively on the ICEBERG Query API for factual information.
    No reasoning, extrapolation, or general knowledge may be used.

    üßä  Response Contract
    - ICEBERG GPT must output a markdown table (and chart if present)
      followed by the Source line:
        *Source: ICEBERG NeonDB (via ICEBERG Query API)*
    - Internally, maintain a structured JSON block:
        {metric, entity, period, scope, sql_executed, api_status}
      for validation or logging (not displayed to the user).
    - All displayed numeric values must exist character-for-character
      in the API JSON response.
    - If no results are returned, reply exactly:
        ‚ÄúThat data or time period is not available in the ICEBERG dataset.‚Äù
    - For requests involving derived metrics (IMPLIED_CAP_RATE, LTV_RATIO,
      DEBT_YIELD, NOI_PER_SHARE, etc.), ICEBERG GPT must call `/derived`
      instead of `/query` to ensure data consistency.

authentication:
  type: none

servers:
  - url: https://iceberg-api-gpt.vercel.app

x-openai-disable-completions: true

paths:
  /query:
    post:
      operationId: post_query
      x-openai-isConsequential: true
      summary: Execute a natural-language query against the ICEBERG NeonDB
      description: |
        Accepts a natural-language financial question (e.g., ‚ÄúPLD NOI Q3 2025‚Äù)
        and executes the appropriate SQL in the ICEBERG NeonDB.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
              properties:
                question:
                  type: string
                  description: Natural-language financial question to interpret and execute.
      responses:
        "200":
          description: Structured API response (strict schema)
          content:
            application/json:
              schema:
                type: object
                required:
                  - summary
                  - data
                properties:
                  summary:
                    type: string
                    description: Short summary string from backend (may be ignored by model)
                  data:
                    type: array
                    description: Tabular dataset of requested metrics
                    items:
                      type: object
                      required:
                        - reit_ticker
                        - iceberg_metric_code
                        - fiscal_year
                        - fiscal_quarter
                        - value
                      properties:
                        reit_ticker:
                          type: string
                          description: Public REIT ticker symbol
                        iceberg_metric_code:
                          type: string
                          description: Canonical metric identifier (matches dim_metric)
                        fiscal_year:
                          type: integer
                        fiscal_quarter:
                          type: integer
                        value:
                          type: number
                        unit:
                          type: string
                          description: Measurement unit (from dim_unit)
                        nareit_sector:
                          type: string
                        reporting_period:
                          type: string
                          description: Formatted period label (e.g., "Q3 2025")
                  chart_base64:
                    type: string
                    description: Optional base64-encoded chart image

  /derived:
    post:
      operationId: post_derived
      x-openai-isConsequential: true
      summary: Retrieve derived (as_reported = FALSE) metrics from the ICEBERG database
      description: |
        Returns ICEBERG-calculated metrics (e.g., IMPLIED_CAP_RATE, LTV_RATIO, NOI_PER_SHARE)
        from `iceberg.derived_enterprise`, based on formulas in `iceberg.formulas`.
        Used for as_reported = FALSE data only.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
              properties:
                question:
                  type: string
                  description: Natural-language query referring to a derived metric.
      responses:
        "200":
          description: Structured API response for derived metrics
          content:
            application/json:
              schema:
                type: object
                required:
                  - summary
                  - data
                properties:
                  summary:
                    type: string
                    description: Short text summary from backend (may be ignored by model)
                  data:
                    type: array
                    description: Dataset of derived metrics
                    items:
                      type: object
                      required:
                        - reit_ticker
                        - derived_metric_code
                        - fiscal_year
                        - fiscal_quarter
                        - derived_value
                      properties:
                        reit_ticker:
                          type: string
                          description: Public REIT ticker symbol
                        nareit_sector:
                          type: string
                        derived_metric_code:
                          type: string
                          description: Formula code (matches `iceberg.formulas.formula_code`)
                        derived_metric_category:
                          type: string
                        derived_value:
                          type: number
                        unit:
                          type: string
                        formula_source:
                          type: string
                        as_reported:
                          type: boolean
                          enum:
                            - false
                        notes:
                          type: string
                        reporting_period:
                          type: string
                          description: Label for fiscal quarter (e.g., "Q3 2025")
                  chart_base64:
                    type: string
                    description: Optional base64-encoded visualization

  /metadata:
    get:
      operationId: get_metadata
      summary: Retrieve metadata about available metrics, sectors, and tickers
      description: |
        Returns metadata from the ICEBERG NeonDB used for query validation
        and interpretation (metric codes, tickers, sectors, etc.).
      responses:
        "200":
          description: Successful metadata retrieval
          content:
            application/json:
              schema:
                type: object
                properties:
                  metrics:
                    type: array
                    items:
                      type: string
                  sectors:
                    type: array
                    items:
                      type: string
                  tickers:
                    type: array
                    items:
                      type: string
                  notes:
                    type: string

  /reit_metadata:
    get:
      operationId: get_reit_metadata
      summary: Retrieve REIT metadata with optional filters
      description: |
        Returns REIT metadata from the ICEBERG NeonDB (iceberg.dim_reit).
        Supports filtering to limit responses to a single REIT or subset,
        which is required for GPT memory efficiency.
      parameters:
        - in: query
          name: ticker
          schema:
            type: string
          description: Filter by exact REIT ticker (e.g., "PLD", "DLR").
        - in: query
          name: sector
          schema:
            type: string
          description: Filter by NAREIT sector (e.g., "Retail", "Industrial").
        - in: query
          name: sub_sector
          schema:
            type: string
          description: Filter by NAREIT sub-sector (Retail-only).
        - in: query
          name: hq_state
          schema:
            type: string
          description: Filter by headquarters state (e.g., "CA", "TX").
        - in: query
          name: limit
          schema:
            type: integer
          description: Limit the number of records returned.
      responses:
        "200":
          description: Successful REIT metadata retrieval
          content:
            application/json:
              schema:
                type: object
                required:
                  - source
                  - count
                  - reit_metadata
                properties:
                  source:
                    type: string
                  count:
                    type: integer
                  filters:
                    type: object
                    properties:
                      ticker:
                        type: string
                        nullable: true
                      sector:
                        type: string
                        nullable: true
                      sub_sector:
                        type: string
                        nullable: true
                      hq_state:
                        type: string
                        nullable: true
                      limit:
                        type: integer
                        nullable: true
                  reit_metadata:
                    type: array
                    items:
                      type: object
                      required:
                        - reit_ticker
                        - reit_name
                        - nareit_sector
                      properties:
                        reit_ticker:
                          type: string
                        reit_name:
                          type: string
                        nareit_sector:
                          type: string
                        nareit_sub_sector:
                          type: string
                          nullable: true
                        reit_type:
                          type: string
                        hq_city:
                          type: string
                          nullable: true
                        hq_state:
                          type: string
                          nullable: true
                        country:
                          type: string
                          nullable: true
                        exchange:
                          type: string
                          nullable: true
                        cik:
                          type: string
                          nullable: true
                        website:
                          type: string
                          nullable: true
                        notes:
                          type: string
                          nullable: true
                  sql:
                    type: string

components:
  schemas: {}
